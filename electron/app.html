<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' data: file: https://fonts.gstatic.com https://fonts.googleapis.com https://cdnjs.cloudflare.com; img-src 'self' data: file: https:; media-src 'self' data: file: https:;" />
    <title>Leakso</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html, body { height: 100%; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: #0b0b0b; color: #fff; }
        .app { display: grid; grid-template-columns: 260px 1fr; grid-template-rows: 64px 1fr 96px; grid-template-areas: 'sidebar topbar' 'sidebar content' 'player player'; height: 100vh; }
        .sidebar { grid-area: sidebar; background: #121212; border-right: 1px solid #222; padding: 16px; display:flex; flex-direction:column; gap: 12px; }
        .brand { display:flex; align-items:center; gap:10px; font-weight:700; font-size: 1.1rem; color:#1db954; }
        .side-group { margin-top: 8px; display:flex; flex-direction:column; gap:8px; }
        .side-link { display:flex; align-items:center; gap:10px; color:#b3b3b3; text-decoration:none; padding:8px 10px; border-radius:8px; }
        .side-link:hover, .side-link.active { background:#1f1f1f; color:#fff; }
        .topbar { grid-area: topbar; display:flex; align-items:center; gap:12px; padding: 0 16px; background:#0f0f0f; border-bottom:1px solid #222; }
        .search { flex:1; display:flex; align-items:center; gap:10px; background:#1a1a1a; border:1px solid #2a2a2a; padding:8px 12px; border-radius:999px; color:#b3b3b3; }
        .search input { flex:1; background:transparent; border:none; outline:none; color:#fff; }
        .content { grid-area: content; padding: 16px; overflow:auto; }
        .section { margin-bottom: 16px; }
        .section h3 { margin: 0 0 12px; font-size: 1.25rem; }
        .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; }
        .card { background:#181818; border:1px solid #242424; border-radius:10px; overflow:hidden; cursor:pointer; transition:transform .15s ease, background .2s ease; }
        .card:hover { transform: translateY(-3px); background:#1f1f1f; }
        .thumb { position:relative; padding-top:100%; background:#222; }
        .thumb img { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; }
        .thumb .btn { position:absolute; right:8px; bottom:8px; width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:999px; background:#1db954; color:#000; }
        .meta { padding:10px; }
        .meta h4 { margin:0 0 4px; font-size:.95rem; color:#fff; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .meta p { margin:0; font-size:.8rem; color:#a7a7a7; }
        .player { grid-area: player; border-top:1px solid #222; background:#0f0f0f; }
        .player .row { height:100%; display:grid; grid-template-columns: 1fr auto 1fr; align-items:center; gap: 12px; padding: 12px 16px; }
        .now { display:flex; align-items:center; gap:10px; }
        .now .cover { width:56px; height:56px; border-radius:8px; overflow:hidden; background:#222; }
        .controls { display:flex; align-items:center; gap:8px; }
        .controls .pp { width:44px; height:44px; border-radius:999px; background:#fff; color:#000; display:flex; align-items:center; justify-content:center; }
        .bar { display:flex; align-items:center; gap:10px; }
        .bar .progress { width:420px; max-width:35vw; height:6px; background:#262626; border-radius:3px; position:relative; cursor:pointer; }
        .bar .progress .fill { position:absolute; left:0; top:0; bottom:0; width:0%; background:#1db954; border-radius:3px; }
        .volume { display:flex; align-items:center; gap:8px; justify-self:end; }
        input[type=range] { accent-color:#1db954; }
    </style>
</head>
<body>
    <div class="app">
        <aside class="sidebar">
            <div class="brand"><i class="fas fa-record-vinyl"></i> <span>Leakso</span></div>
            <div class="side-group">
                <a class="side-link active" data-view="home"><i class="fas fa-home"></i> Home</a>
                <a class="side-link" data-view="browse"><i class="fas fa-compass"></i> Browse</a>
                <a class="side-link" data-view="library"><i class="fas fa-book"></i> Library</a>
                <a class="side-link" id="openSettings"><i class="fas fa-sliders-h"></i> Settings</a>
            </div>
        </aside>

        <header class="topbar">
            <div class="search">
                <i class="fas fa-search"></i>
                <input id="searchInput" placeholder="What do you want to listen to?"/>
            </div>
            <button id="checkUpdatesBtn" class="side-link" style="border:none; background:#1a1a1a; border:1px solid #2a2a2a; padding:8px 12px; border-radius:8px; color:#b3b3b3; cursor:pointer;">
                <i class="fas fa-sync"></i> Check for updates
            </button>
        </header>

        <main class="content">
            <div class="section">
                <h3>Recently added</h3>
                <div class="grid" id="recentGrid"></div>
            </div>
            <div class="section">
                <h3>All tracks</h3>
                <div class="grid" id="allTracksGrid"></div>
            </div>
        </main>

        <footer class="player">
            <div class="row">
                <div class="now">
                    <div class="cover"><img id="playerImage" width="56" height="56"/></div>
                    <div>
                        <div id="playerTitle">No track selected</div>
                        <div id="playerArtist" style="color:#a7a7a7; font-size:.85rem">Select a track to play</div>
                    </div>
                </div>
                <div class="controls">
                    <button id="prevBtn" class="btn"><i class="fas fa-step-backward"></i></button>
                    <button id="playPauseBtn" class="pp"><i class="fas fa-play"></i></button>
                    <button id="nextBtn" class="btn"><i class="fas fa-step-forward"></i></button>
                    <div class="bar">
                        <span class="time current-time">0:00</span>
                        <div class="progress"><div class="fill"></div></div>
                        <span class="time total-time">0:00</span>
                    </div>
                </div>
                <div class="volume">
                    <i class="fas fa-volume-up"></i>
                    <input type="range" class="volume-slider" min="0" max="100" value="50"/>
                </div>
            </div>
        </footer>
    </div>

    <script>
    // Update notifications
    const checkBtn = document.getElementById('checkUpdatesBtn');
    const progressToast = (msg) => {
        const el = document.createElement('div');
        el.textContent = msg;
        el.style.cssText = 'position:fixed; right:16px; bottom:120px; background:#1a1a1a; border:1px solid #2a2a2a; color:#fff; padding:10px 14px; border-radius:8px; z-index:9999;';
        document.body.appendChild(el);
        setTimeout(()=> el.remove(), 3000);
    };

    if (window.leakedsongs) {
        window.leakedsongs.onUpdateAvailable(() => {
            progressToast('Update available. Downloading...');
        });
        window.leakedsongs.onUpdateDownloaded(() => {
            if (confirm('Update downloaded! Restart now to install?')) {
                window.leakedsongs.installUpdate();
            }
        });
    }

    // Music scanning and UI
    let tracks = [];
    let currentTrack = 0;
    let isPlaying = false;
    let currentAudio = null;
    let audioCtx = null;
    let mediaSource = null;
    let gainNode = null;
    let bassFilter = null;

    // DOM elements
    const recentGrid = document.getElementById('recentGrid');
    const allTracksGrid = document.getElementById('allTracksGrid');
    const searchInput = document.getElementById('searchInput');
    const playerImage = document.getElementById('playerImage');
    const playerTitle = document.getElementById('playerTitle');
    const playerArtist = document.getElementById('playerArtist');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const progressFill = document.querySelector('.progress .fill');
    const currentTimeEl = document.querySelector('.current-time');
    const totalTimeEl = document.querySelector('.total-time');
    const volumeSlider = document.querySelector('.volume-slider');

    // Album art mapping
    const albumArtByFolder = {
        'shoreline-mafia': 'https://tse2.mm.bing.net/th/id/OIP.lbTCfkx2FaUULmoZyUI_AQHaHa?rs=1&pid=ImgDetMain&o=7&rm=3',
        'juice-wrld': 'https://www.billboard.com/wp-content/uploads/media/juice-wrld-2018-vmas-b-billboard-1548.jpg',
        'dave-blunts': 'https://images.genius.com/19c856df9f10d7c4e3d3b8c304c66402.1000x1000x1.png',
        'lil-uzi-vert': 'https://i.pinimg.com/736x/65/f0/ab/65f0ab0134d033a7f28d1c8d4c35ca27.jpg'
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        scanAndBuildLibrary();
        setupEventListeners();
        setupSidebarNavigation();
    });

    function scanAndBuildLibrary() {
        try {
            if (!window.leakedsongs || typeof window.leakedsongs.scanMusic !== 'function') {
                console.warn('Electron bridge not available');
                return;
            }
            // Resolve music folder relative to project root
            console.log('Scanning music folder...');
            const files = window.leakedsongs.scanMusic();
            console.log('Found files:', files);
            
            tracks = files.map(f => {
                const rel = f.relative.replace(/\\/g, '/');
                const parts = rel.split('/');
                // rel is relative to project root: music/<artist>/<file>
                const artistFolder = parts[1] || '';
                const filename = parts.slice(2).join('/') || '';
                const title = filename.replace(/\.[^/.]+$/, '');
                return {
                    title,
                    artist: artistFolder.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase()),
                    image: albumArtByFolder[artistFolder] || 'https://images.unsplash.com/photo-1511379938547-c1f69419868d?w=400',
                    audio: rel,
                    category: artistFolder
                };
            });
            console.log('Processed tracks:', tracks);
            if (tracks.length > 0) {
                renderGrids();
            } else {
                console.warn('No tracks found. Check your music folder structure.');
            }
        } catch (e) {
            console.error('Scan failed', e);
        }
    }

    function renderGrids() {
        // Recent tracks (last 6)
        const recentTracks = tracks.slice(Math.max(tracks.length - 6, 0));
        recentGrid.innerHTML = '';
        recentTracks.forEach((track) => {
            const originalIndex = tracks.findIndex(t => t.audio === track.audio);
            const card = createTrackCard(track, originalIndex);
            recentGrid.appendChild(card);
        });

        // All tracks
        allTracksGrid.innerHTML = '';
        tracks.forEach((track, index) => {
            const card = createTrackCard(track, index);
            allTracksGrid.appendChild(card);
        });
    }

    function createTrackCard(track, index) {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
            <div class="thumb">
                <img src="${track.image}" alt="${track.title}">
                <button class="btn" onclick="playTrack(${index})">
                    <i class="fas fa-play"></i>
                </button>
            </div>
            <div class="meta">
                <h4>${track.title}</h4>
                <p>${track.artist}</p>
            </div>
        `;
        return card;
    }

    function setupEventListeners() {
        // Search
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filtered = tracks.filter(t => 
                t.title.toLowerCase().includes(query) || 
                t.artist.toLowerCase().includes(query)
            );
            allTracksGrid.innerHTML = '';
            filtered.forEach((track) => {
                const originalIndex = tracks.findIndex(t => t.audio === track.audio);
                const card = createTrackCard(track, originalIndex);
                allTracksGrid.appendChild(card);
            });
        });

        // Player controls
        playPauseBtn.addEventListener('click', togglePlayPause);
        prevBtn.addEventListener('click', () => playTrack((currentTrack - 1 + tracks.length) % tracks.length));
        nextBtn.addEventListener('click', () => playTrack((currentTrack + 1) % tracks.length));
        
        if (checkBtn) {
            checkBtn.addEventListener('click', async () => {
                if (window.leakedsongs) {
                    const res = await window.leakedsongs.checkForUpdates();
                    if (!res?.ok) {
                        progressToast(res?.error || 'Update check (dev mode): build the app to enable updates');
                    }
                }
            });
        }

        // Volume
        volumeSlider.addEventListener('input', (e) => {
            if (gainNode) {
                gainNode.gain.value = e.target.value / 100;
            }
        });
    }

    function setupSidebarNavigation() {
        const sidebarLinks = document.querySelectorAll('.side-link');
        sidebarLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                
                // Remove active class from all links
                sidebarLinks.forEach(l => l.classList.remove('active'));
                
                // Add active class to clicked link
                link.classList.add('active');
                
                const view = link.getAttribute('data-view');
                console.log('Switching to view:', view);
                
                // Handle different views
                switch(view) {
                    case 'home':
                        showHomeView();
                        break;
                    case 'browse':
                        showBrowseView();
                        break;
                    case 'library':
                        showLibraryView();
                        break;
                    case 'settings':
                        showSettings();
                        break;
                }
            });
        });
    }

    function showHomeView() {
        const content = document.querySelector('.content');
        content.innerHTML = `
            <div class="section">
                <h3>Recently added</h3>
                <div class="grid" id="recentGrid"></div>
            </div>
            <div class="section">
                <h3>All tracks</h3>
                <div class="grid" id="allTracksGrid"></div>
            </div>
        `;
        // Re-render grids
        renderGrids();
    }

    function showBrowseView() {
        const content = document.querySelector('.content');
        content.innerHTML = `
            <div class="section">
                <h3>Browse by Artist</h3>
                <div class="grid" id="artistGrid"></div>
            </div>
        `;
        renderArtistGrid();
    }

    function showLibraryView() {
        const content = document.querySelector('.content');
        content.innerHTML = `
            <div class="section">
                <h3>Your Library</h3>
                <div class="grid" id="libraryGrid"></div>
            </div>
        `;
        renderLibraryGrid();
    }

    function showSettings() {
        const content = document.querySelector('.content');
        content.innerHTML = `
            <div class="section">
                <h3>Audio Settings</h3>
                <div style="max-width: 400px;">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px;">Bass Boost</label>
                        <input type="range" id="bassSlider" min="-20" max="20" value="0" style="width: 100%;">
                        <span id="bassValue">0 dB</span>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px;">Master Volume</label>
                        <input type="range" id="masterVolume" min="0" max="100" value="50" style="width: 100%;">
                        <span id="masterValue">50%</span>
                    </div>
                </div>
            </div>
        `;
        setupSettingsControls();
    }

    function renderArtistGrid() {
        const artistGrid = document.getElementById('artistGrid');
        if (!artistGrid) return;
        
        const artists = [...new Set(tracks.map(t => t.artist))];
        artistGrid.innerHTML = '';
        
        artists.forEach(artist => {
            const artistTracks = tracks.filter(t => t.artist === artist);
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="thumb">
                    <img src="${artistTracks[0].image}" alt="${artist}">
                    <button class="btn" onclick="playArtist('${artist}')">
                        <i class="fas fa-play"></i>
                    </button>
                </div>
                <div class="meta">
                    <h4>${artist}</h4>
                    <p>${artistTracks.length} tracks</p>
                </div>
            `;
            artistGrid.appendChild(card);
        });
    }

    function renderLibraryGrid() {
        const libraryGrid = document.getElementById('libraryGrid');
        if (!libraryGrid) return;
        
        // Show all tracks in library view
        libraryGrid.innerHTML = '';
        tracks.forEach((track, index) => {
            const card = createTrackCard(track, index);
            libraryGrid.appendChild(card);
        });
    }

    function setupSettingsControls() {
        const bassSlider = document.getElementById('bassSlider');
        const bassValue = document.getElementById('bassValue');
        const masterVolume = document.getElementById('masterVolume');
        const masterValue = document.getElementById('masterValue');

        if (bassSlider && bassValue) {
            bassSlider.addEventListener('input', function() {
                if (bassFilter) {
                    bassFilter.gain.value = Number(this.value);
                }
                bassValue.textContent = `${this.value} dB`;
            });
        }

        if (masterVolume && masterValue) {
            masterVolume.addEventListener('input', function() {
                if (gainNode) {
                    gainNode.gain.value = this.value / 100;
                }
                masterValue.textContent = `${this.value}%`;
            });
        }
    }

    function playArtist(artistName) {
        const artistTracks = tracks.filter(t => t.artist === artistName);
        if (artistTracks.length > 0) {
            const firstTrackIndex = tracks.findIndex(t => t.audio === artistTracks[0].audio);
            playTrack(firstTrackIndex);
        }
    }

    // Make functions global
    window.playTrack = playTrack;
    window.playArtist = playArtist;

    function playTrack(index) {
        if (index < 0 || index >= tracks.length) return;
        currentTrack = index;
        const track = tracks[currentTrack];

        // Update player UI
        playerImage.src = track.image;
        playerTitle.textContent = track.title;
        playerArtist.textContent = track.artist;

        // Stop current audio
        if (currentAudio) {
            currentAudio.pause();
            currentAudio.src = '';
            currentAudio = null;
        }

        // Create new audio
        currentAudio = new Audio();
        currentAudio.preload = "metadata";
        // Build a proper file:// URL for Windows paths (handles spaces and special chars)
        const path = require('path');
        const { pathToFileURL } = require('url');
        const absolutePath = path.join(__dirname, '..', track.audio);
        currentAudio.src = pathToFileURL(absolutePath).href;

        // Setup Web Audio
        setupAudioPipeline();

        // Event listeners
        currentAudio.addEventListener('loadedmetadata', () => {
            const duration = currentAudio.duration;
            const minutes = Math.floor(duration / 60);
            const seconds = Math.floor(duration % 60);
            totalTimeEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        });

        currentAudio.addEventListener('timeupdate', () => {
            if (currentAudio.duration) {
                const progress = (currentAudio.currentTime / currentAudio.duration) * 100;
                progressFill.style.width = progress + '%';
                
                const minutes = Math.floor(currentAudio.currentTime / 60);
                const seconds = Math.floor(currentAudio.currentTime % 60);
                currentTimeEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        });

        currentAudio.addEventListener('ended', () => {
            playTrack((currentTrack + 1) % tracks.length);
        });

        // Play
        currentAudio.play().then(() => {
            isPlaying = true;
            playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
        }).catch(console.error);
    }

    function togglePlayPause() {
        if (!currentAudio) return;
        
        if (isPlaying) {
            currentAudio.pause();
            isPlaying = false;
            playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
        } else {
            currentAudio.play().then(() => {
                isPlaying = true;
                playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            }).catch(console.error);
        }
    }

    function setupAudioPipeline() {
        if (!currentAudio) return;
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }

        // Disconnect previous
        if (mediaSource) try { mediaSource.disconnect(); } catch {}
        if (gainNode) try { gainNode.disconnect(); } catch {}
        if (bassFilter) try { bassFilter.disconnect(); } catch {}

        mediaSource = audioCtx.createMediaElementSource(currentAudio);
        gainNode = audioCtx.createGain();
        gainNode.gain.value = volumeSlider.value / 100;

        bassFilter = audioCtx.createBiquadFilter();
        bassFilter.type = 'lowshelf';
        bassFilter.frequency.value = 120;
        bassFilter.gain.value = 0;

        mediaSource.connect(bassFilter);
        bassFilter.connect(gainNode);
        gainNode.connect(audioCtx.destination);
    }

    // Make functions global for onclick handlers
    window.playTrack = playTrack;
    </script>
</body>
</html>


